var $=jQuery,freemageView=wp.media.View.extend({template:wp.template("freemage-search"),className:"attachments-browser",events:{"click .attachments":"imageSelected","keyup #media-search-input":"searchChanged","change #freemage-provider-filters":"filterChanged","change #freemage-license-filters":"filterChanged","click li:not(.downloaded) .freemage-download-label, li:not(.downloaded) .freemage-download":"downloadClicked","wheel .attachments":"scrolled"},initialize:function(){this._prevSearch=null,this.$window=$(window),this.resizeEvent="resize.media-modal-columns",this._downloading=[],this._scrollBottomSearching=!1,this._currentPage=1,_.bindAll(this,"setColumns"),this.on("ready",this.bindEvents),this.controller.on("open",this.setColumns),this.controller.on("open",this.focusSearch.bind(this)),_.defer(this.setColumns,this)},bindEvents:function(){this.$window.off(this.resizeEvent).on(this.resizeEvent,_.debounce(this.setColumns,50))},focusSearch:function(){this.$el.find("#media-search-input").focus()},render:function(){return this.$el.html(this.template()),this.bindEvents(),this},setColumns:function(){var e=this.$el.width();e&&(this.columns=Math.min(Math.round(e/200),12)||1,this.$el.closest(".media-frame-content").attr("data-columns",this.columns))},getLi:function(e){for(var t=e;"LI"!==t.tagName&&"HTML"!==t.tagName;)t=t.parentNode;return"HTML"===t.tagName?null:t},search:function(e){this._appendSearchResultsBound||(this._appendSearchResultsBound=this.appendSearchResult.bind(this)),this._doneSearchingBound||(this._doneSearchingBound=this.doneSearching.bind(this)),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){var t=this.$el.find("#media-search-input").val().trim();if(this._prevSearch!==t&&t||e&&t){this._prevSearch=t,this.$el.find(".spinner").addClass("is-active"),this.clearSearchResults(),this._scrollBottomSearching=!0,this._currentPage=1;var i=this.$el.find("#freemage-provider-filters").val(),a=this.$el.find("#freemage-license-filters").val();Freemage.search(t,this._appendSearchResultsBound,this._doneSearchingBound,this._currentPage,i,a)}}.bind(this),700)},scrolled:function(){if(!this._scrollBottomSearching&&this.$el.find(".attachments li").length){var e=this.$el.find(".attachments");if(e[0].scrollHeight-e.scrollTop()===e.outerHeight()){this._currentPage++,this._scrollBottomSearching=!0;var t=this.$el.find("#media-search-input").val().trim();this.$el.find(".spinner").addClass("is-active");var i=this.$el.find("#freemage-provider-filters").val(),a=this.$el.find("#freemage-license-filters").val();Freemage.search(t,this._appendSearchResultsBound,this._doneSearchingBound,this._currentPage,i,a)}}},searchChanged:function(){this.search()},filterChanged:function(){this.search(!0)},appendSearchResult:function(e){if(e.sizes.length){e.orientation="landscape",e.sizes[0].height>e.sizes[0].width&&(e.orientation="portrait"),e.preview="";var t=this.$el.width();t?t/=this.columns:t=300;for(var i=9999,a=9999,s="",r=0;r<e.sizes.length;r++)"landscape"===e.orientation&&e.sizes[r].height>=t-150&&e.sizes[r].height<i?(e.preview=e.sizes[r].url,i=e.sizes[r].height):"portrait"===e.orientation&&e.sizes[r].width>=t-150&&e.sizes[r].width<i&&(e.preview=e.sizes[r].url,i=e.sizes[r].width),"landscape"===e.orientation&&e.sizes[r].height<a?(s=e.sizes[r].url,a=e.sizes[r].height):"portrait"===e.orientation&&e.sizes[r].width<a&&(s=e.sizes[r].url,a=e.sizes[r].width);e.preview||(e.preview=s);var n=$('<li tabindex="0" role="checkbox" aria-checked="false" class="attachment save-ready">');n.attr("aria-label",e.title),n.html(wp.template("freemage-search-result")(e)),n.data("freemage",e),this.$el.find(".attachments").append(n)}},doneSearching:function(){this.$el.find(".spinner").removeClass("is-active"),this._scrollBottomSearching=!1,0===this.$el.find("ul.attachments li").length&&this.$el.find(".freemage-no-results").removeClass("freemage-hidden")},clearSearchResults:function(){this.$el.find("ul.attachments").html(""),this.$el.find(".freemage-no-results").addClass("freemage-hidden")},imageSelected:function(e){this.$el.find(".details").removeClass("details");var t=this.getLi(e.target);return t?(t.classList.toggle("details"),t.blur(),void this.showSelectedDetails()):void e.target.blur()},showSelectedDetails:function(){var e=this.$el.find(".freemage-details");if("undefined"!=typeof Freemage.providers)for(var t in Freemage.providers)Freemage.providers.hasOwnProperty(t)&&"undefined"!=typeof Freemage.providers[t].onSelectCleanup&&Freemage.providers[t].onSelectCleanup(e);var i=this.getLi(this.$el.find("li.details")[0]);if(!i)return void e.css("display","none");e.css("display","");var a,s=$(i).data("freemage");e.find(".preview").attr("src",s.preview),e.find(".provider span").html($("<a></a>").attr("href",s.provider_link).text(s.provider_name).attr("target","_freemage")),e.find(".title span").text(s.title?s.title:"–"),e.find(".date span").text(s.date?s.date:"–"),s.url?(a=s.url,a.length>30&&(a=a.substring(0,30)+"..."),e.find(".source span").html($("<a></a>").attr("href",s.url).text(a).attr("target","_freemage"))):e.find(".source span").html("–"),s.user?e.find(".owner span").html($("<a></a>").attr("href",s.user_link).text(s.user).attr("target","_freemage")):e.find(".owner span").html("–"),s.license&&s.license_link?e.find(".license span").html($("<a></a>").attr("href",s.license_link).text(s.license).attr("target","_freemage")):s.license?e.find(".license span").html(s.license):e.find(".license span").html("–"),e.find(".sizes span").html("");for(var r=0;r<s.sizes.length;r++){var n=s.sizes[r].width+"x"+s.sizes[r].height;e.find(".sizes span").append("<br>"),e.find(".sizes span").append($("<a></a>").attr("href",s.sizes[r].url).text(n).attr("target","_freemage"))}"undefined"!=typeof Freemage.providers[s.provider]&&"undefined"!=typeof Freemage.providers[s.provider].onSelect&&Freemage.providers[s.provider].onSelect(e,s)},downloadClicked:function(e){var t=this.getLi(e.target);t&&this.downloadImage(t,$(t).data("freemage"))},downloadImage:function(e,t){var i=new XMLHttpRequest;i.onload=function(){i.status>=200&&i.status<400&&($(e).removeClass("downloading").addClass("downloaded"),this.updateMediaManager(JSON.parse(i.response),t))}.bind(this),i.onerror=function(){$(e).removeClass("downloading")}.bind(this);var a=new FormData;a.append("action","freemage_download_image"),a.append("nonce",freemageParams.nonce),a.append("data",JSON.stringify(t)),$(e).addClass("downloading"),i.open("POST",freemageParams.ajax_url),i.send(a)},basename:function(e){return e.split(/[\\/]/).pop()},updateMediaManager:function(e,t){var i;i="undefined"!=typeof wp.media.frame.state().get("library")?wp.media.frame.state().get("library"):wp.media.frame.library;var a=new wp.media.model.Attachment,s={full:{height:e.sizes_data.height,orientation:t.orientation,url:e.attachment_url,width:e.sizes_data.width}};"undefined"!=typeof e.sizes_data.sizes.large&&(s.large={height:e.sizes_data.sizes.large.height,orientation:t.orientation,url:e.attachment_url.replace(this.basename(e.attachment_url),"")+e.sizes_data.sizes.large.file,width:e.sizes_data.sizes.large.width}),"undefined"!=typeof e.sizes_data.sizes.medium&&(s.medium={height:e.sizes_data.sizes.medium.height,orientation:t.orientation,url:e.attachment_url.replace(this.basename(e.attachment_url),"")+e.sizes_data.sizes.medium.file,width:e.sizes_data.sizes.medium.width}),"undefined"!=typeof e.sizes_data.sizes.thumbnail&&(s.thumbnail={height:e.sizes_data.sizes.thumbnail.height,orientation:t.orientation,url:e.attachment_url.replace(this.basename(e.attachment_url),"")+e.sizes_data.sizes.thumbnail.file,width:e.sizes_data.sizes.thumbnail.width});var r={"delete":e.delete_nonce,edit:e.edit_nonce,update:e.update_nonce};a.id=e.id,a.attributes.alt="",a.attributes.author="0",a.attributes.caption=e.attachment_data.post_excerpt,a.attributes.compat=e.compat_fields,a.attributes.date=new Date,a.attributes.dateFormatted=["January","February","March","April","May","June","July","August","September","October","November","December"][(new Date).getMonth()]+" "+(new Date).getDate()+", "+(new Date).getFullYear(),a.attributes.description="",a.attributes.editLink=freemageParams.admin_post_url+"?post="+e.id+"&action=edit",a.attributes.filename=this.basename(e.attachment_url),a.attributes.height=e.sizes_data.height,a.attributes.icon=freemageParams.media_default_url,a.attributes.id=e.id,a.attributes.link=e.attachment_link,a.attributes.menuOrder=0,a.attributes.mime=e.attachment_data.post_mime_type,a.attributes.modified=new Date,a.attributes.name=e.attachment_data.post_name,a.attributes.nonces=r,a.attributes.orientation=t.orientation,a.attributes.sizes=s,a.attributes.status="inherit",a.attributes.subtype=this.basename(e.attachment_data.post_mime_type),a.attributes.title=e.attachment_data.post_title,a.attributes.type="image",a.attributes.uploadedTo=0,a.attributes.url=e.attachment_url,a.attributes.width=e.sizes_data.width,i.models.unshift(a),i.reset(i.models)}});!function(){var e=wp.media.view.MediaFrame.Select.prototype.browseRouter;wp.media.view.MediaFrame.Select.prototype.browseRouter=function(t){e.call(this,t),t.set({freemage:{text:"Freemage Search",priority:100}})}}(),function(){var e=wp.media.view.MediaFrame.Select.prototype.bindHandlers;wp.media.view.MediaFrame.Select.prototype.bindHandlers=function(){e.call(this),this.on("content:create:freemage",this.freemageSearchContent,this)},wp.media.view.MediaFrame.Select.prototype.freemageSearchContent=function(e){this.$el.removeClass("hide-toolbar"),e.view=new freemageView({controller:this})}}(),Freemage={providers:{},_searchesDone:0,_numProviders:0,search:function(e,t,i,a,s,r){if(""!==e.trim()&&(this._searchesDone=0,this._numProviders=0,!(a>5))){var n=!1;for(var o in this.providers)this.providers.hasOwnProperty(o)&&(s&&o!==s||(s||-1!==freemageParams.active_providers.indexOf(o))&&(freemageParams.is_lite&&-1===freemageParams.lite_providers.indexOf(o)||(n=!0,this._numProviders++,function(t,i,a,r,n){var o=50;!s&&freemageParams.active_providers.length>2&&(o=20);var l=t.formURL({keyword:e,license:n,per_page:o,page:a});if(!l)return void r();var d=new XMLHttpRequest;d.onload=function(){d.status>=200&&d.status<400&&t.onload(d.response,i),this._searchesDone++,this._searchesDone===this._numProviders&&r()}.bind(this),d.onerror=function(){this._searchesDone++,this._searchesDone===this._numProviders&&r()}.bind(this),d.open("GET",l),"undefined"!=typeof t.beforeSend&&t.beforeSend(d),d.send()}.bind(this)(this.providers[o],t,a,i,r))));n||i()}}},jQuery(document).ready(function(e){wp.media.featuredImage&&wp.media.featuredImage.select&&!function(){var t=wp.media.featuredImage.select;wp.media.featuredImage.select=function(){t.call(this);var i=this.get("selection").single();if(i.attributes.caption&&i.attributes.filename.match(/^freemage-/))if(e("#content").is(":visible"))e("#content").val(e("#content").val()+"\n\n"+i.attributes.caption);else if(tinyMCE&&tinyMCE.activeEditor){var a=tinyMCE.activeEditor.getContent();tinyMCE.execCommand("mceSetContent",!1,a+"<p>"+i.attributes.caption+"</p>")}}}()}),Freemage.providers.flickr={api:"https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=28b31ed922d1780134dbfb2928d8ef55&text={keyword}&sort=interestingness-desc&content_type=&license={license}&extras=date_taken%2C+license%2C+owner_name%2C+url_sq%2C+url_t%2C+url_s%2C+url_m%2C+url_l%2C+url_o%2C+url_q%2C+description&per_page={per_page}&page={page}&format=json",formURL:function(e){var t=this.api;return t=t.replace(/\{keyword\}/,e.keyword),t=t.replace(/\{per_page\}/,e.per_page),t=t.replace(/\{page\}/,e.page),t="noncommercial"===e.license?t.replace(/\{license\}/,"1,2,3,4,5,6,7"):"noattribution"===e.license?t.replace(/\{license\}/,"7"):t.replace(/\{license\}/,"4,5,6,7")},onload:function(e,t){e=e.replace(/^jsonFlickrApi\(/,""),e=e.replace(/\)$/,"");for(var i=JSON.parse(e),a=0;a<i.photos.photo.length;a++){var s=i.photos.photo[a],r={provider:"flickr",provider_name:freemageParams.providers.flickr,provider_link:"http://flickr.com",user:s.ownername,user_link:"https://www.flickr.com/people/"+s.owner,date:s.datetaken,title:s.title,url:"https://www.flickr.com/photos/"+s.owner+"/"+s.id,badges:[],sizes:[]};"1"===s.license?(r.license="Creative Commons Attribution-NonCommercial-ShareAlike",r.license_link="http://creativecommons.org/licenses/by-nc-sa/2.0/",r.license_shortname="CC BY-NC-SA",r.badges.push("attribution"),r.badges.push("noncommercial")):"2"===s.license?(r.license="Creative Commons Attribution-NonCommercial",r.license_link="http://creativecommons.org/licenses/by-nc/2.0/",r.license_shortname="CC BY-NC",r.badges.push("attribution"),r.badges.push("noncommercial")):"3"===s.license?(r.license="Creative Commons Attribution-NonCommercial-NoDerivs",r.license_link="http://creativecommons.org/licenses/by-nc-nd/2.0/",r.license_shortname="CC BY-NC-ND",r.badges.push("attribution"),r.badges.push("noncommercial")):"4"===s.license?(r.license="Creative Commons Attribution",r.license_link="http://creativecommons.org/licenses/by/2.0/",r.license_shortname="CC BY",r.badges.push("attribution")):"5"===s.license?(r.license="Creative Commons Attribution-ShareAlike",r.license_link="http://creativecommons.org/licenses/by-sa/2.0/",r.license_shortname="CC BY-SA",r.badges.push("attribution")):"6"===s.license?(r.license="Creative Commons Attribution-NoDerivs",r.license_link="http://creativecommons.org/licenses/by-nd/2.0/",r.license_shortname="CC BY-ND",r.badges.push("attribution")):"7"===s.license?(r.license="No known copyright restrictions",r.license_link="http://flickr.com/commons/usage/",r.license_shortname="CC0",r.badges.push("zero")):"8"===s.license&&(r.license="United States Government Work",r.license_link="http://www.usa.gov/copyright.shtml",r.license_shortname="U.S. Gov't Work",r.badges.push("warning")),s.url_s&&r.sizes.push({url:s.url_s,width:parseInt(s.width_s,10),height:parseInt(s.height_s,10)}),s.url_m&&r.sizes.push({url:s.url_m,width:parseInt(s.width_m,10),height:parseInt(s.height_m,10)}),s.url_l&&r.sizes.push({url:s.url_l,width:parseInt(s.width_l,10),height:parseInt(s.height_l,10)}),s.url_o&&r.sizes.push({url:s.url_o,width:parseInt(s.width_o,10),height:parseInt(s.height_o,10)}),t(r)}}},Freemage.providers.giphy={api:"http://api.giphy.com/v1/gifs/search?q={keyword}&limit={per_page}&offset={offset}&api_key=d3ML1IkhgUlWvlja",formURL:function(e){if("noattribution"===e.license)return"";var t=this.api;return t=t.replace(/\{keyword\}/,e.keyword),t=t.replace(/\{per_page\}/,e.per_page),t=t.replace(/\{offset\}/,e.page*e.per_page)},onSelect:function(e){if(0===e.find(".freemage-powered-by-giphy").length){var t=jQuery("<IMG>");t.attr("src",freemageParams.plugin_url+"freemage/images/powered-by-giphy.png").addClass("freemage-powered-by-giphy"),e.find(".thumbnail").after(t)}},onSelectCleanup:function(e){e.find(".freemage-powered-by-giphy").length&&e.find(".freemage-powered-by-giphy").remove()},onload:function(e,t){for(var i=JSON.parse(e),a=0;a<i.data.length;a++){var s=i.data[a],r={provider:"giphy",provider_name:freemageParams.providers.giphy,provider_link:"http://giphy.com",date:s.import_datetime,user:s.username,user_link:s.source||s.url,url:s.url,title:s.slug.replace(/\-\w+$/,"").replace(/\-/g," "),attribution:'Powered by <a href="http://giphy.com">Giphy</a>',license:"Giphy",license_link:"http://giphy.com/terms",license_shortname:"Giphy",badges:["attribution"],sizes:[]};s.user&&(r.user=s.user.display_name,r.user_link=s.user.profile_url),s.images.fixed_height_downsampled&&r.sizes.push({url:s.images.fixed_height_downsampled.url,width:parseInt(s.images.fixed_height_downsampled.width,10),height:parseInt(s.images.fixed_height_downsampled.height,10)}),s.images.original&&r.sizes.push({url:s.images.original.url,width:parseInt(s.images.original.width,10),height:parseInt(s.images.original.height,10)}),t(r)}}};